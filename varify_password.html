<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verification Code</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #fff;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .card-custom {
        width: 580px;
        max-width: 90%;
        padding: 5rem 3rem;
        border-radius: 1rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
      }

      .code-inputs input {
        width: 55px;
        height: 55px;
        text-align: center;
        font-size: 1.5rem;
      }

      .timer {
        color: #0f6546;
      }

      .btn-primary-custom {
        background-color: #0f6546;
        border: none;
        color: #fff;
      }

      .btn-primary-custom:hover {
        background-color: #0c5038;
      }

      .under-button-text a#resend-link {
        color: #0f6546 !important;
        text-decoration: underline !important;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class="card card-custom">
      <h1 class="mb-3">Verification Code</h1>
      <p class="text-muted mb-4">
        Please enter the 4-digit verification code we sent to your email
        address.
      </p>

      <form id="verification-form" class="needs-validation" novalidate>
        <div class="d-flex justify-content-center mb-3 code-inputs">
          <input type="text" maxlength="1" pattern="[0-9]*" class="form-control mx-1" required />
          <input type="text" maxlength="1" pattern="[0-9]*" class="form-control mx-1" required />
          <input type="text" maxlength="1" pattern="[0-9]*" class="form-control mx-1" required />
          <input type="text" maxlength="1" pattern="[0-9]*" class="form-control mx-1" required />
        </div>

        <div class="timer text-center mb-3" id="timer-text">00:30</div>

        <button type="submit" class="btn btn-primary-custom w-100 mb-2">
          Continue
        </button>
      </form>

      <div class="under-button-text text-center">
        If you didn’t receive a code! <a id="resend-link">Resend</a>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
      //  Initialize EmailJS
      (function () {
        emailjs.init("0XfsHu8x1pGBCOYJs");
      })();

      //  Input behavior (prevent letters + auto move)
      const inputs = document.querySelectorAll(".code-inputs input");
      inputs.forEach((input, index) => {
        input.addEventListener("input", () => {
          input.value = input.value.replace(/[^0-9]/g, ""); // يمنع الحروف
          if (input.value.length === 1 && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !input.value && index > 0) {
            inputs[index - 1].focus();
          }
        });
      });

      //  Timer logic
      let timeLeft = 30;
      const timerText = document.getElementById("timer-text");
      let resendDisabled = true; 

      const timerInterval = setInterval(() => {
        if (timeLeft > 0) {
          timeLeft--;
          const seconds = timeLeft.toString().padStart(2, "0");
          timerText.textContent = `00:${seconds}`;
        } else {
          resendDisabled = false; 
        }
      }, 1000);

      document.getElementById("resend-link").addEventListener("click", () => {
        if (resendDisabled) return;

        const email = localStorage.getItem("email");
        if (!email) {
          Swal.fire({
            icon: "warning",
            title: "No email found",
            text: "Please go back and enter your email again.",
          });
          return;
        }

        const newOtp = Math.floor(1000 + Math.random() * 9000);
        const params = { to_email: email, otp: newOtp };

        emailjs
          .send("service_m7hjqye", "template_vqfaygg", params)
          .then(() => {
            Swal.fire({
              icon: "success",
              title: "Code Resent!",
              text: "Verification code resent successfully!",
            });
            localStorage.setItem("otp", newOtp);
            timeLeft = 30;
            resendDisabled = true;
            timerText.textContent = "00:30";
          })
          .catch((err) => {
            console.error("EmailJS Error:", err);
            Swal.fire({
              icon: "error",
              title: "Failed!",
              text: "Failed to resend code. Check console for details.",
            });
          });
      });

      const form = document.getElementById("verification-form");
      form.addEventListener("submit", function (event) {
        event.preventDefault();

        const enteredOtp = Array.from(inputs)
          .map((inp) => inp.value)
          .join("");

        const savedOtp = localStorage.getItem("otp");
        const savedEmail = localStorage.getItem("email");

        if (enteredOtp.length < inputs.length) {
          Swal.fire({
            icon: "warning",
            title: "Incomplete OTP",
            text: "Please enter all OTP digits",
          });
          return;
        }

        if (enteredOtp.trim() !== savedOtp.trim()) {
          Swal.fire({
            icon: "error",
            title: "Incorrect OTP",
            text: "Please try again.",
          });
          return;
        }

        Swal.fire({
          icon: "success",
          title: "Verified!",
          text: "OTP verified successfully for " + savedEmail,
        }).then(() => {
          localStorage.removeItem("otp");
          window.location.href = "New_password.html"; 
        });
      });
    </script>
  </body>
</html>
