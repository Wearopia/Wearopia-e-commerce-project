<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- CryptoJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
    body {
      background-color: #f8fafc;
      font-family: "Poppins", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .card {
      background-color: #fff;
      width: 100%;
      max-width: 460px;
      padding: 2.2rem;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
    }

    h1 {
      font-weight: 600;
      font-size: 1.8rem;
      text-align: center;
    }

    .btn-primary {
      background-color: #0F6546;
      border-color: #0F6546;
      font-weight: 600;
      transition: 0.3s;
    }

    .btn-primary:hover {
      background-color: #0c5038;
      border-color: #0c5038;
      transform: translateY(-1px);
    }

    .password-wrapper {
      position: relative;
    }

    .password-wrapper input {
      padding-right: 44px; /* مساحة للأيقونة */
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .password-toggle svg {
      width: 20px;
      height: 20px;
      stroke: #6b7280;
      stroke-width: 2;
      fill: none;
    }

    .requirements {
      display: none;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.9rem;
      margin-top: 10px;
      color: #6b7280;
    }

    .requirements span.valid {
      color: #0F6546;
      font-weight: 500;
    }

    .requirements span.invalid {
      color: #ef4444;
    }
  </style>
</head>
<body>

  <div class="card">
    <h1 class="mb-3">Create New Password</h1>
    <p class="text-muted text-center mb-4">Make sure your password is strong and secure.</p>

    <form id="reset-form" novalidate>
      <!-- New Password -->
      <div class="mb-3 password-wrapper">
        <label for="new-password" class="form-label">New Password</label>
        <input type="password" id="new-password" class="form-control" placeholder="Enter new password" required>
        <button type="button" class="password-toggle" tabindex="-1">
          <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <svg class="eye-closed" style="display:none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M17.94 17.94A10.95 10.95 0 0 1 12 20c-7 0-11-8-11-8a20.29 20.29 0 0 1 5.06-6.88"/>
            <path d="M1 1l22 22"/>
          </svg>
        </button>
      </div>

      <div class="requirements" id="req-box">
        <span id="lower" class="invalid">• lowercase</span>
        <span id="upper" class="invalid">• uppercase</span>
        <span id="number" class="invalid">• number</span>
        <span id="symbol" class="invalid">• symbol</span>
        <span id="length" class="invalid">• 8+ chars</span>
      </div>

      <!-- Confirm Password -->
      <div class="mb-4 mt-4 password-wrapper">
        <label for="confirm-password" class="form-label">Confirm Password</label>
        <input type="password" id="confirm-password" class="form-control" placeholder="Re-enter new password" required>
        <button type="button" class="password-toggle" tabindex="-1">
          <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <svg class="eye-closed" style="display:none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M17.94 17.94A10.95 10.95 0 0 1 12 20c-7 0-11-8-11-8a20.29 20.29 0 0 1 5.06-6.88"/>
            <path d="M1 1l22 22"/>
          </svg>
        </button>
      </div>

      <button type="submit" class="btn btn-primary w-100">Update Password</button>
    </form>
  </div>

  <script>
    const form = document.getElementById("reset-form");
    const newPassword = document.getElementById("new-password");
    const confirmPassword = document.getElementById("confirm-password");
    const reqBox = document.getElementById("req-box");
    const secretKey = "mySecretKey";

    // Password toggle
    document.querySelectorAll(".password-toggle").forEach((btn) => {
      btn.addEventListener("click", () => {
        const input = btn.previousElementSibling;
        const openIcon = btn.querySelector(".eye-open");
        const closedIcon = btn.querySelector(".eye-closed");
        const isHidden = input.type === "password";
        input.type = isHidden ? "text" : "password";
        openIcon.style.display = isHidden ? "none" : "block";
        closedIcon.style.display = isHidden ? "block" : "none";
      });
    });

    // Password requirements
    const reqs = {
      lower: /[a-z]/,
      upper: /[A-Z]/,
      number: /\d/,
      symbol: /[!@#$%^&*(),.?":{}|<>]/,
      length: /.{8,}/
    };

    newPassword.addEventListener("input", () => {
      reqBox.style.display = newPassword.value.length > 0 ? "flex" : "none";
      const val = newPassword.value;
      for (const [key, regex] of Object.entries(reqs)) {
        const el = document.getElementById(key);
        el.className = regex.test(val) ? "valid" : "invalid";
      }
    });

    // Submit
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const val = newPassword.value;
      const confirmVal = confirmPassword.value;
      const isStrong = Object.values(reqs).every((r) => r.test(val));

      if (!isStrong) {
        Swal.fire("Weak Password", "Your password must meet all the requirements.", "error");
        return;
      }

      if (val !== confirmVal) {
        Swal.fire("Mismatch", "Passwords do not match.", "error");
        return;
      }

      const email = localStorage.getItem("email");
      const encryptedData = localStorage.getItem("users");

      if (!email || !encryptedData) {
        Swal.fire("Error", "User data not found. Please restart the process.", "error");
        return;
      }

      try {
        const bytes = CryptoJS.AES.decrypt(encryptedData, secretKey);
        const decryptedData = bytes.toString(CryptoJS.enc.Utf8);
        const users = JSON.parse(decryptedData);

        const userIndex = users.findIndex(u => u.email === email);
        if (userIndex === -1) {
          Swal.fire("Error", "User not found!", "error");
          return;
        }

        users[userIndex].password = val;
        const updatedEncrypted = CryptoJS.AES.encrypt(JSON.stringify(users), secretKey).toString();
        localStorage.setItem("users", updatedEncrypted);

        Swal.fire({
          icon: "success",
          title: "Password Updated!",
          text: "You can now log in with your new password.",
          confirmButtonColor: "#0F6546"
        }).then(() => {
          localStorage.removeItem("otp");
          localStorage.removeItem("email");
          window.location.href = "login.html";
        });
      } catch (err) {
        console.error(err);
        Swal.fire("Error", "Something went wrong while updating password.", "error");
      }
    });
  </script>
</body>
</html>
